<!DOCTYPE html>
<html>
  <head>
    <title>Getting It Right</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Gadrow" />
    <meta name="date" content="2019-01-17" />
    <link rel="stylesheet" href="include/rstudio.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Getting It Right
## Writing Reliable and Maintainable R Code
### Amanda Gadrow
### 01/17/2019

---




class: panel-narrow-slide, left

# Brilliant intro of some kind

My points:

- What are you trying to accomplish?
- What's the best way to do that?
- Having a good workflow

Reduce content on slides, more images?

---

class: panel-narrow-slide, left

# Data science through code

Purpose of the code:

- To answer a question, or make a prediction, that would be difficult to address manually
- To make it easier to reproduce and improve analyses
- To collaborate with others
- To share findings easily
- To share useful functions internally or with the community


Code is written in the service of analysis

It is a means to an end, but it is also an artifact

---

class: panel-narrow-slide, left

# Data science through code

Characteristics of good code:

- Reliability
- Reproducibility
- Flexibility
- Longevity
- Scalability

---

class: panel-narrow-slide, left

# Code quality matters

How do we determine the quality of our code?

- Execution feedback
- User feedback

---

class: panel-narrow-slide, left

# Code quality matters

How do we determine the quality of our code?

- Execution feedback
- User feedback
- Measure it with tests: functional, integration, performance

---

class: panel-narrow-slide, left

# Code quality matters

How do we determine the quality of our code?

- Execution feedback
- User feedback
- Measure it with tests: functional, integration, performance
- Make this part of your regular development cycle; build it in from the start
  - Faster updates
  - Quick feedback on impact of changes
  - Visibility into internal dependencies
  - Easily trace function, meaning of code

---
class: panel-narrow-slide, left

# Writing tests

- Ideally, cover all code paths
- Practically, start with the major functions, inputs, and integration points
- Run manual tests in the console during development
- Convert them to coded tests when the basic functionality is established

---

class: panel-narrow-slide, left

# Writing tests

- Ideally, cover all code paths
- Practically, start with the major functions, inputs, and integration points
- Run manual tests in the console during development
- Convert them to coded tests when the basic functionality is established

.center[![Image credit: https://images-gmi-pmc.edge-generalmills.com/8890dc0a-ec93-4adf-b496-d6b264b56818.jpg](images/spaghetti.jpg)]

---

class: panel-narrow-slide, left

# Getting started

Test strategy

- Start with the big picture
- Pick a function
- Determine the expected output (positive testing)
- Brainstorm the ways it could go wrong (negative testing)
- Figure out where it touches other code
- Consider performance

---

class: panel-narrow-slide, left

# Manual testing

- Run in the console, usually while developing functions or larger scripts
- Tend to focus on the positive, but don't forget negative and integration tests
- Try different inputs, data, or formats
- Think of potential user mistakes
- Be careful of your global environment

---

class: panel-narrow-slide, left

# Coded testing

- Transfer manual tests to coded tests
- Unit tests, covering a small area of code
- Update and expand as the functional code changes
- Adapt functional code to make it easier to test
- Run when the functional code changes, triggered manually or as part of your CI pipeline (if applicable)
- Pay attention to the results

---

class: panel-narrow-slide, left

# `testthat`


```r
# Install the released version from CRAN
install.packages("testthat")

# Set up test infrastructure:
# Create ‘tests/testthat.R’ and ‘tests/testthat/’, and adding testthat to the suggested packages in the package DESCRIPTION
# install.packages("usethis")
usethis::use_testthat()

# Create a new test file
# Create ‘tests/testthat/test-&lt;name&gt;.R’ and open it for editing
usethis::use_test("name")
```

---

class: panel-narrow-slide, left

# `shinytest`


```r
# install.packages("devtools")
library(devtools)
install_github("rstudio/shinytest")
# shinytest::installDependencies()
library(shinytest)

# Record test
recordTest("path/to/app")

# Run test
testApp("path/to/app")           # all tests
testApp("path/to/app", "mytest") # individual test
```

---

class: panel-narrow-slide, left

# Designing for ease of testing

Good software practices

- Goals
  - Reliability, Reproducibility, Flexibility, Longevity, Scalability
  - Modular design for ease of testing and maintenance (DRY, KISS)
  - Good user experience
  - High degree of confidence

---

class: panel-narrow-slide, left

# Designing for ease of testing

Good software practices

- Goals
  - Reliability, Reproducibility, Flexibility, Longevity, Scalability
  - Modular design for ease of testing and maintenance (DRY, KISS)
  - Good user experience
  - High degree of confidence
- Modular design
  - Decoupling, code isolation
  - DRY: Don't Repeat Yourself
  - KISS: Keep It Simple, Stupid
  - Consistent code style

---

class: panel-narrow-slide, left

# Designing for ease of testing

Good software practices

- Goals
  - Reliability, Reproducibility, Flexibility, Longevity, Scalability
  - Modular design for ease of testing and maintenance (DRY, KISS)
  - Good user experience
  - High degree of confidence
- Modular design
  - Decoupling, code isolation
  - DRY: Don't Repeat Yourself
  - KISS: Keep It Simple, Stupid
  - Consistent code style
- User experience
  - Ease of use
  - Error handling

---

class: panel-narrow-slide, left

# Profit!

But remember:

The tests won't ensure high quality in your script or application; they just verify that it's there.

---

class: panel-narrow-slide, left

# Resources

To read/watch:

- [*R packages*](http://r-pkgs.had.co.nz/package.html), particularly the chapter on [Testing](http://r-pkgs.had.co.nz/tests.html)
- [*Advanced R*](http://adv-r.had.co.nz/), for advice on good software design
- [Jenny Bryan's video](https://www.youtube.com/watch?v=7oyiPBjLAWY) on ["Code smells and feels"](https://rstd.io/code-smells) from useR!2018

---

class: panel-narrow-slide, left

# Resources

To read/watch:

- [*R packages*](http://r-pkgs.had.co.nz/package.html), particularly the chapter on [Testing](http://r-pkgs.had.co.nz/tests.html)
- [*Advanced R*](http://adv-r.had.co.nz/)
- [Jenny Bryan's video](https://www.youtube.com/watch?v=7oyiPBjLAWY) on ["Code smells and feels"](https://rstd.io/code-smells) from useR!2018

To use:

.pull-left[
- [testthat](https://testthat.r-lib.org/)
- [usethis](https://usethis.r-lib.org/)
- [shinytest](https://rstudio.github.io/shinytest/articles/shinytest.html)
- [profvis](https://rstudio.github.io/profvis/) (see also the ["Performance" chapter in *Advanced R*](http://adv-r.had.co.nz/Performance.html))
- [shinyloadtest and shinycannon](https://rstudio.github.io/shinyloadtest/)
]
.pull-right[
- [devtools](https://cran.rstudio.com/web/packages/devtools/index.html)
- [testit](https://github.com/yihui/testit)
- [testthis](https://cran.rstudio.com/web/packages/testthis/index.html)
- [assertive](https://bitbucket.org/richierocks/assertive)
- [RUnit](https://cran.rstudio.com/web/packages/RUnit/index.html)
- [covr](https://cran.rstudio.com/web/packages/covr/index.html) and [covrpage](https://github.com/metrumresearchgroup/covrpage)
]

---

class: panel-narrow-slide, left

# Next steps

- Start small, and give it a go
- Make a habit of running all the tests locally before checking in code
- Add more tests over time
- Integrate tests into CI pipeline
- Bask in the warm glow of reliability, maintainability, and transparency

---

class: blank-slide, blue, center, middle

# Thank you

Amanda Gadrow

amanda@rstudio.com

![](images/ajmcoqui_social_media_sig.png)

.smaller[Slides and code will be available after the conference.]
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"countIncrementalSlides": true,
"highlightLines": true,
"highlightStyle": "github",
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
